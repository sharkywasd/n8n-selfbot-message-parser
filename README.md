# n8n-selftbot
Telegram userbot for analyzing user messages with LLM. Supports local PostgreSQL DB & automatic result messages sending to Telegram chat

## Setup and Build
Все дальнейшие действия, связанные с установкой файлов из данного репозитория производятся пользователем на свой страх и риск. За несоблюдение пользовательского соглашения и правил использования Telegram предусмотрены различные ограничительные меры. Ответственность за их нарушение, а также ответственность за передачу учётных данных аккаунта вы несёте самостоятельно. Все риски и их возможные последствия установки и передачи данных сторонним сервисам несёте только вы.

**0. Клонируем репозиторий в желаемую директорию**

**1. Регистрируем API Development Tools**

https://my.telegram.org/auth

Проходим авторизацию, создаём новое приложение, полуаем API_ID и API_HASH.
Заполняем все поля: App Title, App Shortname, Description, платформу можно оставить по умолчанию.

**2. Билдим контейнер**

Настраиваем переменные в .env: API_ID и API_HASH, логин и пароль для PostgreSQL

`docker compose build`

`docker compose up -d`

Переходим на http://localhost:5678

Проходим регистрацию, проверяем сразу работоспособность ноды и успешность билда:
1) Создаём новый workflow
2) Создаём триггер On chat message
3) В поиске пишем "Tele" и выбираем Telepilot --> Login with phone number using n8n chat, приссоединяем триггер, добавляем credentials:

Если видим что соединение установлено успешно, пишем в чат-триггер ноду `/start`

Пришёл код? Всё работает, продолжаем. Если ошибка сообщает об отсутствии prebuilt libraries - билдим по новой.

В случае успеха создаём воркфлоу для каждого воркфлоу из репозитория и в правом верхнем угулу через меню (многоточие) загружаем последовательно все воркфлоу. Дополнительные инструкции предоставлены на каждом воркфлоу.
![Импорт workflow](<./screenshots/import_workflow.png>)

## Подготавливаем сервисы, ноды, секреты.

**1. Подключение сервисов Google Cloud Console**

1) Вход в аккаунт. Создание нового проекта
https://console.cloud.google.com/projectcreate
2) Перходим в меню APIs & services, в поиске находим `Google Drive API` и включаем. Находим `Google Sheets API`, включаем.
3) Переходим в меню OAuth consent screen, жмём "Get Started". Заполняем название и свой e-mail в App Infomation. В Audience выбираем External. Снова свою почту в Contact Infomation, читаем :\) и принимаем соглашение, создаём. Дальше создаём OAuth client. Выбираем Web Application, название. Добавляем ссылку для редиректа из ноды Google Sheets в n8n в Authorized redirect URIs. **СОХРАНЯЕМ** Client ID и Client Secret.
4) Заходим в меню Audience, вводим свой e-mail в тестовых юзеров, сохраняем.
5) В ноде Google Sheets добавляем новые учётные данные с предыдущих шагов, сохраняем, нажимаем `Sign in with Google` и входим с помощью почты тестового юзера. Если всё было сделано правильно, то получите сообщение об успешном подключении сервиса.

После данных шагов можно создать новую Гугл Таблицу и импортировать неё предлагамую структуру листов и столбцов с помощью Excel файла.

![Импорт структуры таблиц](<./screenshots/sheets.png>)

**2. Создаём учётную запись PostgreSQL**

Действия производятся в воркфлоу Upload messages to DB либо в пустом воркфлоу с добавлением ноды Postgre. При установке проекта необходимо инициализировать БД, инструкции представлены в записке самого воркфлоу.
В соответствующей ноде вводим данные, указанные для БД в .env файле. Порт по умолчанию 5432. Пример заполнения:

![Подключение к БД](<./screenshots/PG.png>)

**3. Получаем API ключ OpenRouter**

Регистрируемся, создаём API ключ, сохраняем. На бесплатном тарифе доступно до 20 запросов в минуту при 50 запросах в день максимум. Чтобы увеличить лимиты, нужно закинуть 10 долларов в "кредиты" на сайте OpenRouter, получите 1000 запросов в день максимум.

**4. Работаем с n8n**

4.1. Поочерёдно импортируем все workflow с помощью .json файлов, если пропустили данный шаг ранее. Описание сценариев и необходимые инструкции описаны в каждом workflow. Краткое описание:
1) Полезные и управляющие сценарии:
 - Session Control (Template by https://n8n.io/creators/ivancore/) - позволяет управлять сессией юзербота и получать уведомления о состоянии сессии. Через этот workflow логинимся в аккаунт с помощью Chat Trigger.
 - Error Catcher - напрвляет сообщения об ошибках выполения workflow в желаемый чат, если выбран в других workflow при возникновении ошибок.
 - Chat_Opener_10_minutes - позволяет получать обновления из групп/чатов с большим количеством обновлений, используется для чатов с нечастыми обновлениями.
 - Chat_Opener_3_minutes - позволяет получать обновления из групп/чатов с большим количеством обновлений, используется для чатов с частыми обновлениями.
2) Прикладные сценарии:
- Channel_ID Parser - позволяет получить метаданные о чате по предоставленной ссылке из листа Google Sheets.
- Cron MessageSender - позвляет отправлять запланированные сообщения в чаты
- Upload messages to DB - автоматическая загрузка входящих сообщений в базу данных при получении нового сообщения на аккаунте
- LLM Analyze DB - отправка данных из БД в LLM-сервис для анализа и сохранения результатов
- LLM UserInfo Sender - отправка данных о пользователях в желаемый чат
- DB Clean-up - удаление нерелевантных записей в базе данных по расписанию

4.2. Для запуска нужных workflow включаем триггеры и публикуем версию workflow. Все последющие изменения должны быть опубликованы для их применения при выполнении сценариев.

В настройках workflow включаем сохранение прогресса выполнения (`Save execution progress`) и указываем запускаемый в случае ошибок workflow:

![Настройки workflow](<./screenshots/errors.png>)

Производим данную операцию для всех необходимых workflow.

## Обновление образа n8n
https://docs.n8n.io/hosting/installation/docker/#updating

С помощью Docker Desktop: нажимаем `Pull` на образе n8n, останавливаем и поднимаем контейнер. Старый образ можно удалить после успешного обновления.

С помощью docker compose:
1) Переходим в директорию проекта
2) `docker compose pull`
3) `docker compose down`
4) `docker compose up -d`

## Особенности:
- Фикс ошибки скрипта установки ноды Telepilot без предустановленных библиотек вследствие ошибки определения ОС Alpine Linux с помощью которой устанавливается стандартный образ n8n (Self-hosted версия с установкой через Docker).
- Фикс ошибки отправки телеметрии (https://github.com/telepilotco/n8n-nodes-telepilot/issues/42)
- Telepilot до сих пор находится в разработке или разработка может быть даже заброшена. Последний релиз - 0.5.2 - май 2025 (Пункт написан 04.01.2026).
- https://github.com/telepilotco/n8n-nodes-telepilot/issues/43
- Может возникнуть проблема с работоспособностью ноды Telepilot при полном отключении сессии и очищении в чате с помощью команд `/stop`, `/clear`: `Chat not found` для чатов, которые на самом деле существуют. Для исправления проблемы вручную запускаем воркфлоу Channel_ID_Parser или испольуем ноды из Telepilot Search public chat by username/title (в случает группы/канала) или ноду-триггер On new message и отправляем на свой аккаунт сообщение с необходимого аккаунта (в случае личного чата).